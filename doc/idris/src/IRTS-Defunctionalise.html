<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html>
<head>
<!-- Generated by HsColour, http://code.haskell.org/~malcolm/hscolour/ -->
<title>src/IRTS/Defunctionalise.hs</title>
<link type='text/css' rel='stylesheet' href='hscolour.css' />
</head>
<body>
<pre><a name="line-1"></a><span class='hs-keyword'>module</span> <span class='hs-conid'>IRTS</span><span class='hs-varop'>.</span><span class='hs-conid'>Defunctionalise</span><span class='hs-layout'>(</span><span class='hs-keyword'>module</span> <span class='hs-conid'>IRTS</span><span class='hs-varop'>.</span><span class='hs-conid'>Defunctionalise</span><span class='hs-layout'>,</span> 
<a name="line-2"></a>                            <span class='hs-keyword'>module</span> <span class='hs-conid'>IRTS</span><span class='hs-varop'>.</span><span class='hs-conid'>Lang</span><span class='hs-layout'>)</span> <span class='hs-keyword'>where</span>
<a name="line-3"></a>
<a name="line-4"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>IRTS</span><span class='hs-varop'>.</span><span class='hs-conid'>Lang</span>
<a name="line-5"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Core</span><span class='hs-varop'>.</span><span class='hs-conid'>TT</span>
<a name="line-6"></a>
<a name="line-7"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Debug</span><span class='hs-varop'>.</span><span class='hs-conid'>Trace</span>
<a name="line-8"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>Maybe</span>
<a name="line-9"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Data</span><span class='hs-varop'>.</span><span class='hs-conid'>List</span>
<a name="line-10"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span>
<a name="line-11"></a><span class='hs-keyword'>import</span> <span class='hs-conid'>Control</span><span class='hs-varop'>.</span><span class='hs-conid'>Monad</span><span class='hs-varop'>.</span><span class='hs-conid'>State</span>
<a name="line-12"></a>
<a name="line-13"></a><a name="DExp"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DExp</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DV</span> <span class='hs-conid'>LVar</span>
<a name="line-14"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DApp</span> <span class='hs-conid'>Bool</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DExp</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- True = tail call</span>
<a name="line-15"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DLet</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>DExp</span> <span class='hs-conid'>DExp</span> <span class='hs-comment'>-- name just for pretty printing</span>
<a name="line-16"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DUpdate</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>DExp</span> <span class='hs-comment'>-- eval expression, then update var with it</span>
<a name="line-17"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DProj</span> <span class='hs-conid'>DExp</span> <span class='hs-conid'>Int</span>
<a name="line-18"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DC</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DExp</span><span class='hs-keyglyph'>]</span>
<a name="line-19"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DCase</span> <span class='hs-conid'>DExp</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DAlt</span><span class='hs-keyglyph'>]</span>
<a name="line-20"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DChkCase</span> <span class='hs-conid'>DExp</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DAlt</span><span class='hs-keyglyph'>]</span> <span class='hs-comment'>-- a case where the type is unknown (for EVAL/APPLY)</span>
<a name="line-21"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DConst</span> <span class='hs-conid'>Const</span>
<a name="line-22"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DForeign</span> <span class='hs-conid'>FLang</span> <span class='hs-conid'>FType</span> <span class='hs-conid'>String</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>FType</span><span class='hs-layout'>,</span> <span class='hs-conid'>DExp</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-23"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DOp</span> <span class='hs-conid'>PrimFn</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DExp</span><span class='hs-keyglyph'>]</span>
<a name="line-24"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DNothing</span> <span class='hs-comment'>-- erased value, can be compiled to anything since it'll never</span>
<a name="line-25"></a>                     <span class='hs-comment'>-- be inspected</span>
<a name="line-26"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DError</span> <span class='hs-conid'>String</span>
<a name="line-27"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-conid'>Eq</span>
<a name="line-28"></a>
<a name="line-29"></a><a name="DAlt"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DAlt</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DConCase</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>DExp</span>
<a name="line-30"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DConstCase</span> <span class='hs-conid'>Const</span> <span class='hs-conid'>DExp</span>
<a name="line-31"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DDefaultCase</span> <span class='hs-conid'>DExp</span>
<a name="line-32"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-33"></a>
<a name="line-34"></a><a name="DDecl"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>DDecl</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DFun</span> <span class='hs-conid'>Name</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>DExp</span> <span class='hs-comment'>-- name, arg names, definition</span>
<a name="line-35"></a>           <span class='hs-keyglyph'>|</span> <span class='hs-conid'>DConstructor</span> <span class='hs-conid'>Name</span> <span class='hs-conid'>Int</span> <span class='hs-conid'>Int</span> <span class='hs-comment'>-- constructor name, tag, arity</span>
<a name="line-36"></a>  <span class='hs-keyword'>deriving</span> <span class='hs-layout'>(</span><span class='hs-conid'>Show</span><span class='hs-layout'>,</span> <span class='hs-conid'>Eq</span><span class='hs-layout'>)</span>
<a name="line-37"></a>
<a name="line-38"></a><a name="DDefs"></a><span class='hs-keyword'>type</span> <span class='hs-conid'>DDefs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Ctxt</span> <span class='hs-conid'>DDecl</span>
<a name="line-39"></a>
<a name="line-40"></a><a name="defunctionalise"></a><span class='hs-definition'>defunctionalise</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LDefs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>DDefs</span> 
<a name="line-41"></a><span class='hs-definition'>defunctionalise</span> <span class='hs-varid'>nexttag</span> <span class='hs-varid'>defs</span> 
<a name="line-42"></a>     <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>all</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>toAlist</span> <span class='hs-varid'>defs</span>
<a name="line-43"></a>           <span class='hs-comment'>-- sort newcons so that EVAL and APPLY cons get sequential tags</span>
<a name="line-44"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>allD</span><span class='hs-layout'>,</span> <span class='hs-varid'>enames</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>runState</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>addApps</span> <span class='hs-varid'>defs</span><span class='hs-layout'>)</span> <span class='hs-varid'>all</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span>
<a name="line-45"></a>           <span class='hs-varid'>newcons</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>conord</span> <span class='hs-varop'>$</span> <span class='hs-varid'>concatMap</span> <span class='hs-layout'>(</span><span class='hs-varid'>toCons</span> <span class='hs-varid'>enames</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>getFn</span> <span class='hs-varid'>all</span><span class='hs-layout'>)</span>
<a name="line-46"></a>           <span class='hs-varid'>eval</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkEval</span> <span class='hs-varid'>newcons</span>
<a name="line-47"></a>           <span class='hs-varid'>app</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkApply</span> <span class='hs-varid'>newcons</span>
<a name="line-48"></a>           <span class='hs-varid'>condecls</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>declare</span> <span class='hs-varid'>nexttag</span> <span class='hs-varid'>newcons</span> <span class='hs-keyword'>in</span>
<a name="line-49"></a>           <span class='hs-varid'>addAlist</span> <span class='hs-layout'>(</span><span class='hs-varid'>eval</span> <span class='hs-conop'>:</span> <span class='hs-varid'>app</span> <span class='hs-conop'>:</span> <span class='hs-varid'>condecls</span> <span class='hs-varop'>++</span> <span class='hs-varid'>allD</span><span class='hs-layout'>)</span> <span class='hs-varid'>emptyContext</span>
<a name="line-50"></a>   <span class='hs-keyword'>where</span> <span class='hs-varid'>conord</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>n'</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>n</span> <span class='hs-varid'>n'</span>
<a name="line-51"></a>
<a name="line-52"></a><a name="getFn"></a><span class='hs-definition'>getFn</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-53"></a><span class='hs-definition'>getFn</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>fnData</span> <span class='hs-varid'>xs</span>
<a name="line-54"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>fnData</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>LFun</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> 
<a name="line-55"></a>        <span class='hs-varid'>fnData</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-56"></a>
<a name="line-57"></a><span class='hs-comment'>-- To defunctionalise:</span>
<a name="line-58"></a><span class='hs-comment'>--</span>
<a name="line-59"></a><span class='hs-comment'>-- 1 Create a data constructor for each function</span>
<a name="line-60"></a><span class='hs-comment'>-- 2 Create a data constructor for each underapplication of a function</span>
<a name="line-61"></a><span class='hs-comment'>-- 3 Convert underapplications to their corresponding constructors</span>
<a name="line-62"></a><span class='hs-comment'>-- 4 Create an EVAL function which calls the appropriate function for data constructors</span>
<a name="line-63"></a><span class='hs-comment'>--   created as part of step 1</span>
<a name="line-64"></a><span class='hs-comment'>-- 5 Create an APPLY function which adds an argument to each underapplication (or calls</span>
<a name="line-65"></a><span class='hs-comment'>--   APPLY again for an exact application)</span>
<a name="line-66"></a><span class='hs-comment'>-- 6 Wrap overapplications in chains of APPLY</span>
<a name="line-67"></a><span class='hs-comment'>-- 7 Wrap unknown applications (i.e. applications of local variables) in chains of APPLY</span>
<a name="line-68"></a><span class='hs-comment'>-- 8 Add explicit EVAL to case, primitives, and foreign calls</span>
<a name="line-69"></a>
<a name="line-70"></a><a name="addApps"></a><span class='hs-definition'>addApps</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>LDefs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>LDecl</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>State</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DDecl</span><span class='hs-layout'>)</span>
<a name="line-71"></a><span class='hs-definition'>addApps</span> <span class='hs-varid'>defs</span> <span class='hs-varid'>o</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>LConstructor</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>t</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-72"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>DConstructor</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> 
<a name="line-73"></a><span class='hs-definition'>addApps</span> <span class='hs-varid'>defs</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>LFun</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-74"></a>    <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>args</span> <span class='hs-varid'>e</span>
<a name="line-75"></a>         <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>DFun</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-76"></a>  <span class='hs-keyword'>where</span>
<a name="line-77"></a>    <span class='hs-varid'>aa</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>LExp</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>State</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-conid'>DExp</span>
<a name="line-78"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>env</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-79"></a>                         <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>LV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-conid'>[]</span><span class='hs-layout'>)</span>
<a name="line-80"></a><span class='hs-comment'>--     aa env e@(LApp tc (MN 0 "EVAL") [a]) = e</span>
<a name="line-81"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-conid'>LV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-82"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span> 
<a name="line-83"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupCtxt</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>n</span> <span class='hs-varid'>defs</span> <span class='hs-keyword'>of</span>
<a name="line-84"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConstructor</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args'</span>
<a name="line-85"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFun</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>in</span>
<a name="line-86"></a>                                       <span class='hs-varid'>fixApply</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>arity</span>
<a name="line-87"></a>                <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>chainAPPLY</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span>
<a name="line-88"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LLazyApp</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-89"></a>       <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-90"></a>            <span class='hs-keyword'>case</span> <span class='hs-varid'>lookupCtxt</span> <span class='hs-conid'>Nothing</span> <span class='hs-varid'>n</span> <span class='hs-varid'>defs</span> <span class='hs-keyword'>of</span>
<a name="line-91"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>LConstructor</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>i</span> <span class='hs-varid'>ar</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args'</span>
<a name="line-92"></a>                <span class='hs-keyglyph'>[</span><span class='hs-conid'>LFun</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>_</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>arity</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>length</span> <span class='hs-keyword'>as</span> <span class='hs-keyword'>in</span>
<a name="line-93"></a>                                       <span class='hs-varid'>fixLazyApply</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args'</span> <span class='hs-varid'>arity</span>
<a name="line-94"></a>                <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>chainAPPLY</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args'</span>
<a name="line-95"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LForce</span> <span class='hs-layout'>(</span><span class='hs-conid'>LLazyApp</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>LV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-96"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LForce</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-varid'>eEVAL</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-97"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LLet</span> <span class='hs-varid'>n</span> <span class='hs-varid'>v</span> <span class='hs-varid'>sc</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM2</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLet</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>sc</span><span class='hs-layout'>)</span>
<a name="line-98"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCon</span> <span class='hs-varid'>i</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DC</span> <span class='hs-varid'>i</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-99"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LProj</span> <span class='hs-varid'>t</span><span class='hs-keyglyph'>@</span><span class='hs-layout'>(</span><span class='hs-conid'>LV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> 
<a name="line-100"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t</span>
<a name="line-101"></a>             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DProj</span> <span class='hs-layout'>(</span><span class='hs-conid'>DUpdate</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>eEVAL</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-102"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LProj</span> <span class='hs-varid'>t</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>t'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>t</span>
<a name="line-103"></a>                            <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DProj</span> <span class='hs-layout'>(</span><span class='hs-varid'>eEVAL</span> <span class='hs-varid'>t'</span><span class='hs-layout'>)</span> <span class='hs-varid'>i</span>
<a name="line-104"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-105"></a>                               <span class='hs-varid'>alts'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aaAlt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span>
<a name="line-106"></a>                               <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>eEVAL</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts'</span>
<a name="line-107"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConst</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DConst</span> <span class='hs-varid'>c</span>
<a name="line-108"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LForeign</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DForeign</span> <span class='hs-varid'>l</span> <span class='hs-varid'>t</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aaF</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-109"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LOp</span> <span class='hs-conid'>LFork</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DOp</span> <span class='hs-conid'>LFork</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-110"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LOp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>args'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>mapM</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-111"></a>                             <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DOp</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>eEVAL</span> <span class='hs-varid'>args'</span><span class='hs-layout'>)</span>
<a name="line-112"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-conid'>LNothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-conid'>DNothing</span>
<a name="line-113"></a>    <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LError</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DError</span> <span class='hs-varid'>e</span>
<a name="line-114"></a>
<a name="line-115"></a>    <span class='hs-varid'>aaF</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>e'</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-116"></a>                        <span class='hs-varid'>return</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-varid'>eEVAL</span> <span class='hs-varid'>e'</span><span class='hs-layout'>)</span>
<a name="line-117"></a>
<a name="line-118"></a>    <span class='hs-varid'>aaAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConCase</span> <span class='hs-varid'>i</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-119"></a>         <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-varid'>i</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-layout'>(</span><span class='hs-varid'>args</span> <span class='hs-varop'>++</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-120"></a>    <span class='hs-varid'>aaAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LConstCase</span> <span class='hs-varid'>c</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-121"></a>    <span class='hs-varid'>aaAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>LDefaultCase</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>liftM</span> <span class='hs-conid'>DDefaultCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>aa</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span>
<a name="line-122"></a>
<a name="line-123"></a>    <span class='hs-varid'>fixApply</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ar</span> 
<a name="line-124"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ar</span> 
<a name="line-125"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span>
<a name="line-126"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>ar</span> 
<a name="line-127"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-128"></a>                  <span class='hs-varid'>put</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-129"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DApp</span> <span class='hs-varid'>tc</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnderCon</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>ar</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-130"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>ar</span> 
<a name="line-131"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>chainAPPLY</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-varid'>tc</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-132"></a>
<a name="line-133"></a>    <span class='hs-varid'>fixLazyApply</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>ar</span> 
<a name="line-134"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ar</span> 
<a name="line-135"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-136"></a>                  <span class='hs-varid'>put</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-137"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFnCon</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-138"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>ar</span> 
<a name="line-139"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>do</span> <span class='hs-varid'>ns</span> <span class='hs-keyglyph'>&lt;-</span> <span class='hs-varid'>get</span>
<a name="line-140"></a>                  <span class='hs-varid'>put</span> <span class='hs-varop'>$</span> <span class='hs-varid'>nub</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-conop'>:</span> <span class='hs-varid'>ns</span><span class='hs-layout'>)</span>
<a name="line-141"></a>                  <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnderCon</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>ar</span> <span class='hs-comment'>-</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span>
<a name="line-142"></a>        <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>args</span> <span class='hs-varop'>&gt;</span> <span class='hs-varid'>ar</span> 
<a name="line-143"></a>             <span class='hs-keyglyph'>=</span> <span class='hs-varid'>return</span> <span class='hs-varop'>$</span> <span class='hs-varid'>chainAPPLY</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>drop</span> <span class='hs-varid'>ar</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-144"></a>                                    
<a name="line-145"></a>    <span class='hs-varid'>chainAPPLY</span> <span class='hs-varid'>f</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>f</span>
<a name="line-146"></a>    <span class='hs-varid'>chainAPPLY</span> <span class='hs-varid'>f</span> <span class='hs-layout'>(</span><span class='hs-varid'>a</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>as</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>chainAPPLY</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"APPLY"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>f</span><span class='hs-layout'>,</span> <span class='hs-varid'>a</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-keyword'>as</span>
<a name="line-147"></a>
<a name="line-148"></a>    <span class='hs-comment'>-- if anything in the DExp is projected from, we'll need to evaluate it,</span>
<a name="line-149"></a>    <span class='hs-comment'>-- but we only want to do it once, rather than every time we project.</span>
<a name="line-150"></a>
<a name="line-151"></a>    <span class='hs-varid'>preEval</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span>
<a name="line-152"></a>    <span class='hs-varid'>preEval</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-conop'>:</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>t</span> 
<a name="line-153"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DLet</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-varid'>eEVAL</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>preEval</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span>
<a name="line-154"></a>       <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>preEval</span> <span class='hs-varid'>xs</span> <span class='hs-varid'>t</span>
<a name="line-155"></a>
<a name="line-156"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>or</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-157"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DC</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>or</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-158"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span> <span class='hs-varop'>||</span> <span class='hs-varid'>or</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>nec</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-159"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>nec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-160"></a>            <span class='hs-varid'>nec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-161"></a>            <span class='hs-varid'>nec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-162"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DChkCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span> <span class='hs-varop'>||</span> <span class='hs-varid'>or</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>nec</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-163"></a>      <span class='hs-keyword'>where</span> <span class='hs-varid'>nec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-164"></a>            <span class='hs-varid'>nec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-165"></a>            <span class='hs-varid'>nec</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-166"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLet</span> <span class='hs-varid'>n</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-167"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>v</span>
<a name="line-168"></a>          <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>v</span> <span class='hs-varop'>||</span> <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-varid'>e</span>
<a name="line-169"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DForeign</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>or</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-170"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DOp</span> <span class='hs-varid'>op</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>or</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-171"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>DProj</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>x'</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span> <span class='hs-varop'>==</span> <span class='hs-varid'>x'</span>
<a name="line-172"></a>    <span class='hs-varid'>needsEval</span> <span class='hs-varid'>x</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-173"></a>
<a name="line-174"></a><a name="eEVAL"></a><span class='hs-definition'>eEVAL</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"EVAL"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>x</span><span class='hs-keyglyph'>]</span>
<a name="line-175"></a>
<a name="line-176"></a><a name="EvalApply"></a><span class='hs-keyword'>data</span> <span class='hs-conid'>EvalApply</span> <span class='hs-varid'>a</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EvalCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span>
<a name="line-177"></a>                 <span class='hs-keyglyph'>|</span> <span class='hs-conid'>ApplyCase</span> <span class='hs-varid'>a</span>
<a name="line-178"></a><span class='hs-comment'>--     deriving Show</span>
<a name="line-179"></a>
<a name="line-180"></a><span class='hs-comment'>-- For a function name, generate a list of</span>
<a name="line-181"></a><span class='hs-comment'>-- data constuctors, and whether to handle them in EVAL or APPLY</span>
<a name="line-182"></a>
<a name="line-183"></a><a name="toCons"></a><span class='hs-definition'>toCons</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>Name</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvalApply</span> <span class='hs-conid'>DAlt</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-184"></a><span class='hs-definition'>toCons</span> <span class='hs-varid'>ns</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> 
<a name="line-185"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>`elem`</span> <span class='hs-varid'>ns</span>
<a name="line-186"></a>      <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFnCon</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>i</span><span class='hs-layout'>,</span> 
<a name="line-187"></a>          <span class='hs-conid'>EvalCase</span> <span class='hs-layout'>(</span><span class='hs-keyglyph'>\</span><span class='hs-varid'>tlarg</span> <span class='hs-keyglyph'>-&gt;</span>
<a name="line-188"></a>            <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkFnCon</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>genArgs</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-189"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>dupdate</span> <span class='hs-varid'>tlarg</span>
<a name="line-190"></a>                <span class='hs-layout'>(</span><span class='hs-varid'>eEVAL</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Glob</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-varid'>genArgs</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-191"></a>          <span class='hs-conop'>:</span> <span class='hs-varid'>mkApplyCase</span> <span class='hs-varid'>n</span> <span class='hs-num'>0</span> <span class='hs-varid'>i</span>
<a name="line-192"></a>    <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-193"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>dupdate</span> <span class='hs-varid'>tlarg</span> <span class='hs-varid'>x</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>x</span>
<a name="line-194"></a>
<a name="line-195"></a><a name="mkApplyCase"></a><span class='hs-definition'>mkApplyCase</span> <span class='hs-varid'>fname</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>|</span> <span class='hs-varid'>n</span> <span class='hs-varop'>==</span> <span class='hs-varid'>ar</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-196"></a><span class='hs-definition'>mkApplyCase</span> <span class='hs-varid'>fname</span> <span class='hs-varid'>n</span> <span class='hs-varid'>ar</span> 
<a name="line-197"></a>        <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-varid'>nm</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>mkUnderCon</span> <span class='hs-varid'>fname</span> <span class='hs-layout'>(</span><span class='hs-varid'>ar</span> <span class='hs-comment'>-</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span> <span class='hs-keyword'>in</span>
<a name="line-198"></a>              <span class='hs-layout'>(</span><span class='hs-varid'>nm</span><span class='hs-layout'>,</span> <span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>ApplyCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-layout'>(</span><span class='hs-comment'>-</span><span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>nm</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>genArgs</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-199"></a>                  <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-varid'>mkUnderCon</span> <span class='hs-varid'>fname</span> <span class='hs-layout'>(</span><span class='hs-varid'>ar</span> <span class='hs-comment'>-</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-200"></a>                       <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-varop'>.</span> <span class='hs-conid'>Glob</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>take</span> <span class='hs-varid'>n</span> <span class='hs-layout'>(</span><span class='hs-varid'>genArgs</span> <span class='hs-num'>0</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> 
<a name="line-201"></a>                         <span class='hs-keyglyph'>[</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"arg"</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-202"></a>                            <span class='hs-conop'>:</span> <span class='hs-varid'>mkApplyCase</span> <span class='hs-varid'>fname</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>ar</span>
<a name="line-203"></a>
<a name="line-204"></a><a name="mkEval"></a><span class='hs-definition'>mkEval</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvalApply</span> <span class='hs-conid'>DAlt</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DDecl</span><span class='hs-layout'>)</span>
<a name="line-205"></a><span class='hs-definition'>mkEval</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"EVAL"</span><span class='hs-layout'>,</span> <span class='hs-conid'>DFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"EVAL"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"arg"</span><span class='hs-keyglyph'>]</span>
<a name="line-206"></a>               <span class='hs-layout'>(</span><span class='hs-varid'>mkBigCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"EVAL"</span><span class='hs-layout'>)</span> <span class='hs-num'>256</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"arg"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-207"></a>                  <span class='hs-layout'>(</span><span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>evalCase</span> <span class='hs-varid'>xs</span> <span class='hs-varop'>++</span>
<a name="line-208"></a>                      <span class='hs-keyglyph'>[</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"arg"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-209"></a>  <span class='hs-keyword'>where</span>
<a name="line-210"></a>    <span class='hs-varid'>evalCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvalCase</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"arg"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> 
<a name="line-211"></a>    <span class='hs-varid'>evalCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-212"></a>
<a name="line-213"></a><a name="mkApply"></a><span class='hs-definition'>mkApply</span> <span class='hs-keyglyph'>::</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvalApply</span> <span class='hs-conid'>DAlt</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DDecl</span><span class='hs-layout'>)</span>
<a name="line-214"></a><span class='hs-definition'>mkApply</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"APPLY"</span><span class='hs-layout'>,</span> <span class='hs-conid'>DFun</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"APPLY"</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"fn"</span><span class='hs-layout'>,</span> <span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"arg"</span><span class='hs-keyglyph'>]</span>
<a name="line-215"></a>                             <span class='hs-layout'>(</span><span class='hs-varid'>mkBigCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"APPLY"</span><span class='hs-layout'>)</span>
<a name="line-216"></a>                                        <span class='hs-num'>256</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-conid'>False</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"EVAL"</span><span class='hs-layout'>)</span>
<a name="line-217"></a>                                            <span class='hs-keyglyph'>[</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-layout'>(</span><span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-str'>"fn"</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span>
<a name="line-218"></a>                                 <span class='hs-layout'>(</span><span class='hs-varid'>mapMaybe</span> <span class='hs-varid'>applyCase</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-219"></a>  <span class='hs-keyword'>where</span>
<a name="line-220"></a>    <span class='hs-varid'>applyCase</span> <span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>t</span><span class='hs-layout'>,</span> <span class='hs-conid'>ApplyCase</span> <span class='hs-varid'>x</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Just</span> <span class='hs-varid'>x</span>
<a name="line-221"></a>    <span class='hs-varid'>applyCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>Nothing</span>
<a name="line-222"></a>
<a name="line-223"></a>
<a name="line-224"></a><a name="declare"></a><span class='hs-definition'>declare</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>Int</span><span class='hs-layout'>,</span> <span class='hs-conid'>EvalApply</span> <span class='hs-conid'>DAlt</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-layout'>(</span><span class='hs-conid'>Name</span><span class='hs-layout'>,</span> <span class='hs-conid'>DDecl</span><span class='hs-layout'>)</span><span class='hs-keyglyph'>]</span>
<a name="line-225"></a><span class='hs-definition'>declare</span> <span class='hs-varid'>t</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dec'</span> <span class='hs-varid'>t</span> <span class='hs-varid'>xs</span> <span class='hs-conid'>[]</span> <span class='hs-keyword'>where</span>
<a name="line-226"></a>   <span class='hs-varid'>dec'</span> <span class='hs-varid'>t</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>reverse</span> <span class='hs-varid'>acc</span>
<a name="line-227"></a>   <span class='hs-varid'>dec'</span> <span class='hs-varid'>t</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-varid'>ar</span><span class='hs-layout'>,</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span> <span class='hs-varid'>acc</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>dec'</span> <span class='hs-layout'>(</span><span class='hs-varid'>t</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-layout'>(</span><span class='hs-layout'>(</span><span class='hs-varid'>n</span><span class='hs-layout'>,</span> <span class='hs-conid'>DConstructor</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span> <span class='hs-varid'>ar</span><span class='hs-layout'>)</span> <span class='hs-conop'>:</span> <span class='hs-varid'>acc</span><span class='hs-layout'>)</span>
<a name="line-228"></a>
<a name="line-229"></a>
<a name="line-230"></a><a name="genArgs"></a><span class='hs-definition'>genArgs</span> <span class='hs-varid'>i</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MN</span> <span class='hs-varid'>i</span> <span class='hs-str'>"P_c"</span> <span class='hs-conop'>:</span> <span class='hs-varid'>genArgs</span> <span class='hs-layout'>(</span><span class='hs-varid'>i</span> <span class='hs-varop'>+</span> <span class='hs-num'>1</span><span class='hs-layout'>)</span>
<a name="line-231"></a>
<a name="line-232"></a><a name="mkFnCon"></a><span class='hs-definition'>mkFnCon</span>    <span class='hs-varid'>n</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MN</span> <span class='hs-num'>0</span> <span class='hs-layout'>(</span><span class='hs-str'>"P_"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-233"></a><a name="mkUnderCon"></a><span class='hs-definition'>mkUnderCon</span> <span class='hs-varid'>n</span> <span class='hs-num'>0</span>       <span class='hs-keyglyph'>=</span> <span class='hs-varid'>n</span>
<a name="line-234"></a><span class='hs-definition'>mkUnderCon</span> <span class='hs-varid'>n</span> <span class='hs-varid'>missing</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>MN</span> <span class='hs-varid'>missing</span> <span class='hs-layout'>(</span><span class='hs-str'>"U_"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span>
<a name="line-235"></a>
<a name="line-236"></a><a name="instance%20Show%20DExp"></a><span class='hs-keyword'>instance</span> <span class='hs-conid'>Show</span> <span class='hs-conid'>DExp</span> <span class='hs-keyword'>where</span>
<a name="line-237"></a>   <span class='hs-varid'>show</span> <span class='hs-varid'>e</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show'</span> <span class='hs-conid'>[]</span> <span class='hs-varid'>e</span> <span class='hs-keyword'>where</span>
<a name="line-238"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Loc</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"var "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>env</span><span class='hs-varop'>!!</span><span class='hs-varid'>i</span>
<a name="line-239"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DV</span> <span class='hs-layout'>(</span><span class='hs-conid'>Glob</span> <span class='hs-varid'>n</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span>
<a name="line-240"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DApp</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>e</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>e</span> <span class='hs-varop'>++</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span>
<a name="line-241"></a>                                   <span class='hs-varid'>showSep</span> <span class='hs-str'>", "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>show'</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span><span class='hs-str'>")"</span>
<a name="line-242"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DLet</span> <span class='hs-varid'>n</span> <span class='hs-varid'>v</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"let "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>" = "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>v</span> <span class='hs-varop'>++</span> <span class='hs-str'>" in "</span> <span class='hs-varop'>++</span>
<a name="line-243"></a>                               <span class='hs-varid'>show'</span> <span class='hs-layout'>(</span><span class='hs-varid'>env</span> <span class='hs-varop'>++</span> <span class='hs-keyglyph'>[</span><span class='hs-varid'>show</span> <span class='hs-varid'>n</span><span class='hs-keyglyph'>]</span><span class='hs-layout'>)</span> <span class='hs-varid'>e</span>
<a name="line-244"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DUpdate</span> <span class='hs-varid'>n</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"!update "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-245"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DC</span> <span class='hs-varid'>i</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSep</span> <span class='hs-str'>", "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>show'</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-246"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DProj</span> <span class='hs-varid'>t</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>t</span> <span class='hs-varop'>++</span> <span class='hs-str'>"!"</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>i</span>
<a name="line-247"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"case "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span> <span class='hs-varop'>++</span> <span class='hs-str'>" of {\n\t"</span> <span class='hs-varop'>++</span>
<a name="line-248"></a>                                    <span class='hs-varid'>showSep</span> <span class='hs-str'>"\n\t| "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>showAlt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-249"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DChkCase</span> <span class='hs-varid'>e</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"case' "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span> <span class='hs-varop'>++</span> <span class='hs-str'>" of {\n\t"</span> <span class='hs-varop'>++</span>
<a name="line-250"></a>                                    <span class='hs-varid'>showSep</span> <span class='hs-str'>"\n\t| "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>showAlt</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>alts</span><span class='hs-layout'>)</span>
<a name="line-251"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConst</span> <span class='hs-varid'>c</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>c</span>
<a name="line-252"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DForeign</span> <span class='hs-varid'>lang</span> <span class='hs-varid'>ty</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span>
<a name="line-253"></a>           <span class='hs-keyglyph'>=</span> <span class='hs-str'>"foreign "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSep</span> <span class='hs-str'>", "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>show'</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>snd</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-254"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DOp</span> <span class='hs-varid'>f</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>f</span> <span class='hs-varop'>++</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSep</span> <span class='hs-str'>", "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-layout'>(</span><span class='hs-varid'>show'</span> <span class='hs-varid'>env</span><span class='hs-layout'>)</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>")"</span>
<a name="line-255"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DError</span> <span class='hs-varid'>str</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"error "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>str</span>
<a name="line-256"></a>     <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-conid'>DNothing</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"____"</span>
<a name="line-257"></a>
<a name="line-258"></a>     <span class='hs-varid'>showAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-varid'>n</span> <span class='hs-varid'>args</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> 
<a name="line-259"></a>          <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSep</span> <span class='hs-str'>", "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>show</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>") =&gt; "</span>
<a name="line-260"></a>             <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-261"></a>     <span class='hs-varid'>showAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-varid'>c</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>c</span> <span class='hs-varop'>++</span> <span class='hs-str'>" =&gt; "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-262"></a>     <span class='hs-varid'>showAlt</span> <span class='hs-varid'>env</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-varid'>e</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"_ =&gt; "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show'</span> <span class='hs-varid'>env</span> <span class='hs-varid'>e</span>
<a name="line-263"></a>
<a name="line-264"></a><span class='hs-comment'>-- Divide up a large case expression so that each has a maximum of</span>
<a name="line-265"></a><span class='hs-comment'>-- 'max' branches</span>
<a name="line-266"></a>
<a name="line-267"></a><a name="mkBigCase"></a><span class='hs-definition'>mkBigCase</span> <span class='hs-varid'>cn</span> <span class='hs-varid'>max</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>branches</span> 
<a name="line-268"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>length</span> <span class='hs-varid'>branches</span> <span class='hs-varop'>&lt;=</span> <span class='hs-varid'>max</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DChkCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>branches</span>
<a name="line-269"></a>   <span class='hs-keyglyph'>|</span> <span class='hs-varid'>otherwise</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-- DChkCase arg branches -- until I think of something...</span>
<a name="line-270"></a>       <span class='hs-comment'>-- divide the branches into groups of at most max (by tag),</span>
<a name="line-271"></a>       <span class='hs-comment'>-- generate a new case and shrink, recursively</span>
<a name="line-272"></a>       <span class='hs-keyword'>let</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>sortBy</span> <span class='hs-varid'>tagOrd</span> <span class='hs-varid'>branches</span>
<a name="line-273"></a>           <span class='hs-layout'>(</span><span class='hs-varid'>all</span><span class='hs-layout'>,</span> <span class='hs-varid'>def</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>case</span> <span class='hs-layout'>(</span><span class='hs-varid'>last</span> <span class='hs-varid'>bs</span><span class='hs-layout'>)</span> <span class='hs-keyword'>of</span>
<a name="line-274"></a>                    <span class='hs-conid'>DDefaultCase</span> <span class='hs-varid'>t</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>init</span> <span class='hs-varid'>all</span><span class='hs-layout'>,</span> <span class='hs-conid'>Just</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-varid'>t</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span>
<a name="line-275"></a>                    <span class='hs-keyword'>_</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-layout'>(</span><span class='hs-varid'>all</span><span class='hs-layout'>,</span> <span class='hs-conid'>Nothing</span><span class='hs-layout'>)</span>
<a name="line-276"></a>           <span class='hs-varid'>bss</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>groupsOf</span> <span class='hs-varid'>max</span> <span class='hs-varid'>all</span>
<a name="line-277"></a>           <span class='hs-varid'>cs</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>map</span> <span class='hs-varid'>mkCase</span> <span class='hs-varid'>bss</span> <span class='hs-keyword'>in</span>
<a name="line-278"></a>           <span class='hs-conid'>DChkCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>branches</span>
<a name="line-279"></a>
<a name="line-280"></a>    <span class='hs-keyword'>where</span> <span class='hs-varid'>mkCase</span> <span class='hs-varid'>bs</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>DChkCase</span> <span class='hs-varid'>arg</span> <span class='hs-varid'>bs</span> 
<a name="line-281"></a>
<a name="line-282"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-varid'>t'</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>t</span> <span class='hs-varid'>t'</span>
<a name="line-283"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-varid'>c</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-varid'>c'</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>compare</span> <span class='hs-varid'>c</span> <span class='hs-varid'>c'</span>
<a name="line-284"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>EQ</span>
<a name="line-285"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-286"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-287"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>LT</span>
<a name="line-288"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-289"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-290"></a>          <span class='hs-varid'>tagOrd</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>GT</span>
<a name="line-291"></a>          
<a name="line-292"></a>
<a name="line-293"></a><a name="groupsOf"></a><span class='hs-definition'>groupsOf</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>Int</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-conid'>DAlt</span><span class='hs-keyglyph'>]</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-keyglyph'>[</span><span class='hs-keyglyph'>[</span><span class='hs-conid'>DAlt</span><span class='hs-keyglyph'>]</span><span class='hs-keyglyph'>]</span>
<a name="line-294"></a><span class='hs-definition'>groupsOf</span> <span class='hs-varid'>x</span> <span class='hs-conid'>[]</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>[]</span>
<a name="line-295"></a><span class='hs-definition'>groupsOf</span> <span class='hs-varid'>x</span> <span class='hs-varid'>xs</span> <span class='hs-keyglyph'>=</span> <span class='hs-keyword'>let</span> <span class='hs-layout'>(</span><span class='hs-varid'>batch</span><span class='hs-layout'>,</span> <span class='hs-varid'>rest</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>span</span> <span class='hs-layout'>(</span><span class='hs-varid'>tagLT</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span> <span class='hs-varop'>+</span> <span class='hs-varid'>tagHead</span> <span class='hs-varid'>xs</span><span class='hs-layout'>)</span><span class='hs-layout'>)</span> <span class='hs-varid'>xs</span> <span class='hs-keyword'>in</span>
<a name="line-296"></a>                    <span class='hs-varid'>batch</span> <span class='hs-conop'>:</span> <span class='hs-varid'>groupsOf</span> <span class='hs-varid'>x</span> <span class='hs-varid'>rest</span>
<a name="line-297"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>tagHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span> <span class='hs-varid'>i</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span>
<a name="line-298"></a>        <span class='hs-varid'>tagHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-varid'>t</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>t</span>
<a name="line-299"></a>        <span class='hs-varid'>tagHead</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span> <span class='hs-conop'>:</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-comment'>-</span><span class='hs-num'>1</span> <span class='hs-comment'>-- must be the end</span>
<a name="line-300"></a>
<a name="line-301"></a>        <span class='hs-varid'>tagLT</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConstCase</span> <span class='hs-layout'>(</span><span class='hs-conid'>I</span> <span class='hs-varid'>j</span><span class='hs-layout'>)</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>j</span>
<a name="line-302"></a>        <span class='hs-varid'>tagLT</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-conid'>DConCase</span> <span class='hs-varid'>j</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>i</span> <span class='hs-varop'>&lt;</span> <span class='hs-varid'>j</span>
<a name="line-303"></a>        <span class='hs-varid'>tagLT</span> <span class='hs-varid'>i</span> <span class='hs-layout'>(</span><span class='hs-conid'>DDefaultCase</span> <span class='hs-keyword'>_</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-conid'>False</span>
<a name="line-304"></a>
<a name="line-305"></a><a name="dumpDefuns"></a><span class='hs-definition'>dumpDefuns</span> <span class='hs-keyglyph'>::</span> <span class='hs-conid'>DDefs</span> <span class='hs-keyglyph'>-&gt;</span> <span class='hs-conid'>String</span>
<a name="line-306"></a><span class='hs-definition'>dumpDefuns</span> <span class='hs-varid'>ds</span> <span class='hs-keyglyph'>=</span> <span class='hs-varid'>showSep</span> <span class='hs-str'>"\n"</span> <span class='hs-varop'>$</span> <span class='hs-varid'>map</span> <span class='hs-varid'>showDef</span> <span class='hs-layout'>(</span><span class='hs-varid'>toAlist</span> <span class='hs-varid'>ds</span><span class='hs-layout'>)</span>
<a name="line-307"></a>  <span class='hs-keyword'>where</span> <span class='hs-varid'>showDef</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>DFun</span> <span class='hs-varid'>fn</span> <span class='hs-varid'>args</span> <span class='hs-varid'>exp</span><span class='hs-layout'>)</span> 
<a name="line-308"></a>            <span class='hs-keyglyph'>=</span> <span class='hs-varid'>show</span> <span class='hs-varid'>fn</span> <span class='hs-varop'>++</span> <span class='hs-str'>"("</span> <span class='hs-varop'>++</span> <span class='hs-varid'>showSep</span> <span class='hs-str'>", "</span> <span class='hs-layout'>(</span><span class='hs-varid'>map</span> <span class='hs-varid'>show</span> <span class='hs-varid'>args</span><span class='hs-layout'>)</span> <span class='hs-varop'>++</span> <span class='hs-str'>") = \n\t"</span> <span class='hs-varop'>++</span>
<a name="line-309"></a>              <span class='hs-varid'>show</span> <span class='hs-varid'>exp</span> <span class='hs-varop'>++</span> <span class='hs-str'>"\n"</span>
<a name="line-310"></a>        <span class='hs-varid'>showDef</span> <span class='hs-layout'>(</span><span class='hs-varid'>x</span><span class='hs-layout'>,</span> <span class='hs-conid'>DConstructor</span> <span class='hs-varid'>n</span> <span class='hs-varid'>t</span> <span class='hs-varid'>a</span><span class='hs-layout'>)</span> <span class='hs-keyglyph'>=</span> <span class='hs-str'>"Constructor "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>n</span> <span class='hs-varop'>++</span> <span class='hs-str'>" "</span> <span class='hs-varop'>++</span> <span class='hs-varid'>show</span> <span class='hs-varid'>t</span>
<a name="line-311"></a>
<a name="line-312"></a>
</pre></body>
</html>
